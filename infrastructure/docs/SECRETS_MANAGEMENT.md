# Secrets Management Strategy

This document explains how secrets are managed across Terraform, AWS Secrets Manager, and GitHub Secrets to maintain a **single source of truth** and prevent state desynchronization issues.

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        SINGLE SOURCE OF TRUTH                    │
│                                                                  │
│                         TERRAFORM STATE                          │
│                  (infrastructure/terraform/)                     │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   Cognito    │  │  RDS/Aurora  │  │   E2E Test   │          │
│  │  User Pools  │  │  Credentials │  │    Users     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└──────────────────────────┬──────────────────────────────────────┘
                           │
                           │ Automated Sync
                           ▼
        ┌──────────────────────────────────────────┐
        │                                          │
        │    AWS Secrets Manager                   │
        │    (e2e-test-credentials,                │
        │     db-credentials)                      │
        │                                          │
        └──────────────────────────────────────────┘
                           │
                           │ Automated Sync
                           ▼
        ┌──────────────────────────────────────────┐
        │                                          │
        │       GitHub Secrets                     │
        │       (E2E_TEST_USER_EMAIL,              │
        │        STAGING_COGNITO_*,                │
        │        PRODUCTION_COGNITO_*)             │
        │                                          │
        └──────────────────────────────────────────┘
                           │
                           │ Used by
                           ▼
        ┌──────────────────────────────────────────┐
        │                                          │
        │     GitHub Actions Workflows             │
        │     (deploy-staging.yml,                 │
        │      deploy-production.yml)              │
        │                                          │
        └──────────────────────────────────────────┘
```

## The Problem We're Solving

**Before** (Manual Secret Management):
- Secrets created manually in Cognito
- Manually copied to GitHub Secrets
- Manually copied to AWS Secrets Manager
- ❌ Three independent sources of truth
- ❌ Frequent desynchronization
- ❌ "Incorrect username or password" errors

**After** (Terraform-Managed Secrets):
- Secrets generated by Terraform
- Automatically synced to AWS Secrets Manager
- Automatically synced to GitHub Secrets
- ✅ Single source of truth (Terraform state)
- ✅ Always synchronized
- ✅ No manual intervention needed

## Workflow

### 1. Apply Terraform Changes

When you run `terraform apply`, Terraform:
1. Creates/updates AWS resources (Cognito, RDS, etc.)
2. Generates random passwords via `random_password` resource
3. Stores credentials in AWS Secrets Manager
4. Outputs values for GitHub Secrets sync

```bash
cd infrastructure/terraform
terraform workspace select staging  # or production
terraform apply -var-file=staging.tfvars
```

### 2. Sync Secrets to GitHub

**Option A: Automated (via GitHub Actions)**

Trigger the sync workflow manually:

```bash
gh workflow run sync-terraform-secrets.yml -f environment=staging
```

Or via GitHub UI:
1. Go to Actions → "Sync Terraform Outputs to GitHub Secrets"
2. Click "Run workflow"
3. Select environment (staging/production)
4. Click "Run workflow"

**Option B: Local Script**

Run the helper script:

```bash
./infrastructure/scripts/sync-github-secrets.sh staging
```

This will:
- Read Terraform outputs
- Update all relevant GitHub Secrets
- Print a summary of changes

### 3. Deploy and Test

After syncing, your deployments will automatically use the correct credentials:

```bash
# Staging deployment uses synced secrets
git push origin dev

# Production deployment uses synced secrets
gh pr create --base main --head dev
```

## Secret Categories

### Infrastructure Secrets (per environment)

Automatically synced from Terraform:

| GitHub Secret | Terraform Output | Purpose |
|--------------|------------------|---------|
| `STAGING_ECS_CLUSTER` | `ecs_cluster_name` | ECS cluster name |
| `STAGING_ECS_SERVICE` | `ecs_service_name` | ECS service name |
| `STAGING_ECR_REPOSITORY` | `ecr_repository_name` | Docker repository |
| `STAGING_API_URL` | `alb_url` | Backend API endpoint |
| `STAGING_S3_BUCKET` | `s3_bucket_name` | Frontend S3 bucket |
| `STAGING_CLOUDFRONT_ID` | `cloudfront_distribution_id` | CloudFront distribution |
| `STAGING_FRONTEND_URL` | `cloudfront_url` | Frontend URL |
| `STAGING_COGNITO_USER_POOL_ID` | `cognito_user_pool_id` | Cognito user pool |
| `STAGING_COGNITO_CLIENT_ID` | `cognito_client_id` | Cognito app client |

*Same pattern for `PRODUCTION_*` secrets*

### Test Credentials (staging only)

| GitHub Secret | Terraform Output | Purpose |
|--------------|------------------|---------|
| `E2E_TEST_USER_EMAIL` | `e2e_test_user_email` | E2E test user email |
| `E2E_TEST_USER_PASSWORD` | `e2e_test_user_password` | E2E test user password |

### AWS Access (shared across environments)

| GitHub Secret | Source | Purpose |
|--------------|--------|---------|
| `AWS_ROLE_TO_ASSUME` | Terraform output `github_actions_role_arn` | GitHub Actions OIDC role |

## Terraform Resources

### Credentials Generated by Terraform

1. **E2E Test User** (`infrastructure/terraform/s3-cognito.tf`):
   ```hcl
   resource "random_password" "e2e_test_user" {
     length  = 16
     special = true
   }

   resource "aws_cognito_user" "e2e_test_user" {
     user_pool_id = aws_cognito_user_pool.main.id
     username     = "e2e-test@embark-quoting.local"
     # ...
   }
   ```

2. **Database Credentials** (`infrastructure/terraform/rds.tf`):
   ```hcl
   resource "random_password" "db_password" {
     length  = 32
     special = true
   }

   resource "aws_db_instance" "main" {
     password = random_password.db_password.result
     # ...
   }
   ```

3. **AWS Secrets Manager** (automatic):
   ```hcl
   resource "aws_secretsmanager_secret_version" "e2e_test_credentials" {
     secret_id = aws_secretsmanager_secret.e2e_test_credentials.id
     secret_string = jsonencode({
       email    = aws_cognito_user.e2e_test_user.username
       password = random_password.e2e_test_user.result
     })
   }
   ```

## Troubleshooting

### "Incorrect username or password" Error

This usually means secrets are out of sync. To fix:

1. **Check Terraform state**:
   ```bash
   cd infrastructure/terraform
   terraform workspace select staging
   terraform output e2e_test_user_email
   terraform output e2e_test_user_password  # sensitive
   ```

2. **Verify Cognito user exists**:
   ```bash
   aws cognito-idp list-users \
     --user-pool-id $(terraform output -raw cognito_user_pool_id)
   ```

3. **Re-sync secrets**:
   ```bash
   ./infrastructure/scripts/sync-github-secrets.sh staging
   ```

4. **If user was manually deleted**, recreate via Terraform:
   ```bash
   terraform taint aws_cognito_user.e2e_test_user
   terraform apply -var-file=staging.tfvars -target=aws_cognito_user.e2e_test_user
   ./infrastructure/scripts/sync-github-secrets.sh staging
   ```

### GitHub Secret Not Updating

If secrets aren't syncing:

1. **Check GitHub CLI authentication**:
   ```bash
   gh auth status
   ```

2. **Check permissions**:
   - GitHub token needs `repo` scope
   - GitHub Actions needs `secrets: write` permission

3. **Manual update as fallback**:
   ```bash
   gh secret set STAGING_COGNITO_USER_POOL_ID \
     --body "$(cd infrastructure/terraform && terraform output -raw cognito_user_pool_id)"
   ```

### Terraform State Drift

If Terraform state doesn't match reality:

1. **Refresh Terraform state**:
   ```bash
   cd infrastructure/terraform
   terraform workspace select staging
   terraform refresh -var-file=staging.tfvars
   ```

2. **Import resources** (if created manually):
   ```bash
   terraform import aws_cognito_user.e2e_test_user \
     "ap-southeast-2_D2t5oQs37/e2e-test@embark-quoting.local"
   ```

## Best Practices

### ✅ DO

- **Always use Terraform** for infrastructure changes
- **Run sync script** after every `terraform apply`
- **Verify sync** before running deployments
- **Use Terraform outputs** as the source of truth
- **Store Terraform state** in S3 with locking (DynamoDB)

### ❌ DON'T

- **Don't create users manually** in Cognito
- **Don't update GitHub Secrets manually** (use sync script)
- **Don't hardcode passwords** in Terraform (use `random_password`)
- **Don't commit secrets** to Git
- **Don't skip syncing** after Terraform changes

## Integration with CI/CD

### Staging Deployment

```yaml
# .github/workflows/deploy-staging.yml
jobs:
  deploy-backend:
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}  # From Terraform

      - name: Deploy to ECS
        env:
          ECS_CLUSTER: ${{ secrets.STAGING_ECS_CLUSTER }}    # From Terraform
          ECS_SERVICE: ${{ secrets.STAGING_ECS_SERVICE }}    # From Terraform
```

### E2E Tests

```yaml
# .github/workflows/deploy-staging.yml
jobs:
  e2e-tests:
    steps:
      - name: Run E2E tests
        env:
          E2E_TEST_USER_EMAIL: ${{ secrets.E2E_TEST_USER_EMAIL }}        # From Terraform
          E2E_TEST_USER_PASSWORD: ${{ secrets.E2E_TEST_USER_PASSWORD }}  # From Terraform
```

## Migration Path

If you have existing manually-created secrets:

1. **Audit current state**:
   ```bash
   gh secret list | grep -E "(STAGING|PRODUCTION|E2E)"
   ```

2. **Run initial Terraform apply**:
   ```bash
   cd infrastructure/terraform
   terraform workspace select staging
   terraform apply -var-file=staging.tfvars
   ```

3. **Sync all secrets**:
   ```bash
   ./infrastructure/scripts/sync-github-secrets.sh staging
   ./infrastructure/scripts/sync-github-secrets.sh production
   ```

4. **Test deployments**:
   ```bash
   # Trigger staging deployment
   git push origin dev

   # Verify E2E tests pass
   gh run list --workflow "Deploy to Staging" --limit 1
   ```

5. **Delete manual users** (optional):
   ```bash
   # Keep manual test users if desired for manual testing
   # Or delete them to enforce Terraform-only management
   ```

## Automation Opportunities

Future enhancements:

1. **Auto-sync on Terraform apply**:
   - Add `local-exec` provisioner to Terraform
   - Automatically trigger sync workflow

2. **Drift detection**:
   - Scheduled workflow to compare Terraform vs GitHub
   - Alert on desynchronization

3. **Pull request comments**:
   - Show which secrets will change
   - Require approval before syncing

---

## Summary

**Single Source of Truth**: Terraform state
**Automatic Sync**: Secrets flow from Terraform → AWS → GitHub
**No Manual Intervention**: All secrets managed via code
**Always Synchronized**: Eliminates "incorrect password" errors

For questions or issues, see the troubleshooting section or check the debug-specialist subagent.
