name: E2E Tests (Manual)

# Manual trigger for fast E2E debugging
#
# Use cases:
#   1. Debug E2E failures without full deployment
#   2. Test specific E2E scenarios (e.g., only sync tests)
#   3. Run E2E tests against local/custom environments
#
# Calls the reusable e2e-tests-reusable.yml workflow

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        type: choice
        options:
          - staging
          - production
          - custom
        default: 'staging'
      custom-base-url:
        description: 'Custom frontend URL (only if environment=custom)'
        required: false
        type: string
      custom-api-url:
        description: 'Custom API URL (only if environment=custom)'
        required: false
        type: string
      test-pattern:
        description: 'Test pattern (e.g., "e2e/sync.spec.ts" or blank for all)'
        required: false
        type: string
        default: ''

jobs:
  # Resolve environment URLs
  prepare:
    name: Resolve Environment
    runs-on: ubuntu-latest
    outputs:
      base-url: ${{ steps.resolve.outputs.base-url }}
      api-url: ${{ steps.resolve.outputs.api-url }}
      environment: ${{ steps.resolve.outputs.environment }}

    steps:
      - name: Resolve URLs
        id: resolve
        run: |
          case "${{ inputs.environment }}" in
            staging)
              echo "base-url=${{ secrets.STAGING_FRONTEND_URL }}" >> $GITHUB_OUTPUT
              echo "api-url=${{ secrets.STAGING_API_URL }}" >> $GITHUB_OUTPUT
              echo "environment=staging" >> $GITHUB_OUTPUT
              ;;
            production)
              echo "base-url=${{ secrets.PRODUCTION_FRONTEND_URL }}" >> $GITHUB_OUTPUT
              echo "api-url=${{ secrets.PRODUCTION_API_URL }}" >> $GITHUB_OUTPUT
              echo "environment=production" >> $GITHUB_OUTPUT
              ;;
            custom)
              if [ -z "${{ inputs.custom-base-url }}" ] || [ -z "${{ inputs.custom-api-url }}" ]; then
                echo "âŒ Custom environment requires both base-url and api-url"
                exit 1
              fi
              echo "base-url=${{ inputs.custom-base-url }}" >> $GITHUB_OUTPUT
              echo "api-url=${{ inputs.custom-api-url }}" >> $GITHUB_OUTPUT
              echo "environment=custom" >> $GITHUB_OUTPUT
              ;;
          esac

  # Call reusable E2E workflow
  run-e2e:
    name: Run E2E Tests
    needs: prepare
    uses: ./.github/workflows/e2e-tests-reusable.yml
    with:
      base-url: ${{ needs.prepare.outputs.base-url }}
      api-url: ${{ needs.prepare.outputs.api-url }}
      environment: ${{ needs.prepare.outputs.environment }}
      test-pattern: ${{ inputs.test-pattern }}
    secrets:
      test-user-email: ${{ secrets.E2E_TEST_USER_EMAIL }}
      test-user-password: ${{ secrets.E2E_TEST_USER_PASSWORD }}
