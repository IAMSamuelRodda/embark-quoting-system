name: E2E Tests (Single Source of Truth)

# SINGLE SOURCE OF TRUTH for all E2E testing
# Usage:
#   1. Manual trigger: Run this workflow directly with custom inputs
#   2. Automatic: Called by deploy-staging.yml and deploy-prod.yml
#
# This is the ONLY place E2E test logic exists

on:
  # Allow manual triggering with custom parameters
  workflow_dispatch:
    inputs:
      base-url:
        description: 'Frontend URL to test (or leave blank for staging default)'
        required: false
        type: string
      api-url:
        description: 'Backend API URL to test (or leave blank for staging default)'
        required: false
        type: string
      environment:
        description: 'Environment name'
        required: false
        type: choice
        options:
          - staging
          - production
          - custom
        default: 'staging'
      test-pattern:
        description: 'Test pattern (blank = all tests, e2e/auth.spec.ts = auth only)'
        required: false
        type: string
        default: ''

  # Allow calling from other workflows
  workflow_call:
    inputs:
      base-url:
        description: 'Frontend URL to test against (leave blank to use secret)'
        required: false
        type: string
      api-url:
        description: 'Backend API URL to test against (leave blank to use secret)'
        required: false
        type: string
      environment:
        description: 'Environment name (staging/production/local)'
        required: false
        type: string
        default: 'staging'
      test-pattern:
        description: 'Test pattern to run (e.g., "e2e/sync.spec.ts" or blank for all)'
        required: false
        type: string
        default: ''
    secrets:
      base-url-secret:
        description: 'Frontend URL from secrets (if not provided as input)'
        required: false
      api-url-secret:
        description: 'Backend API URL from secrets (if not provided as input)'
        required: false
      test-user-email:
        description: 'E2E test user email'
        required: true
      test-user-password:
        description: 'E2E test user password'
        required: true

jobs:
  e2e-tests:
    name: E2E Tests (${{ inputs.environment }})
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Resolve URLs (for manual triggers and reusable workflow calls)
        id: resolve-urls
        run: |
          # Priority: 1) input parameter, 2) secret parameter, 3) staging defaults
          BASE_URL="${{ inputs.base-url }}"
          API_URL="${{ inputs.api-url }}"

          # If not provided as input, try secret parameter
          if [ -z "$BASE_URL" ]; then
            BASE_URL="${{ secrets.base-url-secret }}"
            echo "Using frontend URL from secrets parameter"
          fi

          if [ -z "$API_URL" ]; then
            API_URL="${{ secrets.api-url-secret }}"
            echo "Using API URL from secrets parameter"
          fi

          # Fallback to staging defaults for manual triggers
          if [ -z "$BASE_URL" ]; then
            BASE_URL="${{ secrets.STAGING_FRONTEND_URL }}"
            echo "Using staging frontend URL from secrets (fallback)"
          fi

          if [ -z "$API_URL" ]; then
            API_URL="${{ secrets.STAGING_API_URL }}"
            echo "Using staging API URL from secrets (fallback)"
          fi

          echo "base-url=${BASE_URL}" >> $GITHUB_OUTPUT
          echo "api-url=${API_URL}" >> $GITHUB_OUTPUT

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./frontend
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # Skip man page updates during package installation (saves ~80 seconds)
          sudo mkdir -p /etc/dpkg/dpkg.cfg.d
          echo 'path-exclude=/usr/share/man/*' | sudo tee /etc/dpkg/dpkg.cfg.d/01_nodoc

          npx playwright install --with-deps chromium

      - name: Verify connectivity
        run: |
          echo "ðŸ” E2E Test Configuration:"
          echo "  Environment: ${{ inputs.environment }}"
          echo "  Frontend URL: ${{ steps.resolve-urls.outputs.base-url }}"
          echo "  API URL: ${{ steps.resolve-urls.outputs.api-url }}"
          echo "  Test User: ${{ secrets.test-user-email }}"
          echo "  Test Pattern: ${{ inputs.test-pattern || 'all E2E tests' }}"
          echo ""

          echo "ðŸŒ Testing frontend connectivity..."
          if curl -f -s -o /dev/null -w "HTTP %{http_code} in %{time_total}s\n" "${{ steps.resolve-urls.outputs.base-url }}"; then
            echo "âœ… Frontend is reachable"
          else
            echo "âŒ Frontend is not reachable at ${{ steps.resolve-urls.outputs.base-url }}"
            echo "Attempting to diagnose..."
            curl -v "${{ steps.resolve-urls.outputs.base-url }}" 2>&1 | head -20
            exit 1
          fi
          echo ""

          echo "ðŸŒ Testing API connectivity..."
          if curl -f -s -o /dev/null -w "HTTP %{http_code} in %{time_total}s\n" "${{ steps.resolve-urls.outputs.api-url }}/health"; then
            echo "âœ… API is reachable"
          else
            echo "âŒ API is not reachable at ${{ steps.resolve-urls.outputs.api-url }}"
            exit 1
          fi

      - name: Run E2E tests
        working-directory: ./frontend
        timeout-minutes: 5
        run: |
          echo "ðŸ§ª Running E2E tests..."
          echo "  Base URL: $E2E_BASE_URL"
          echo "  API URL: $E2E_API_URL"
          echo "  Pattern: ${{ inputs.test-pattern || 'all tests' }}"
          echo ""

          # Export environment variables for Playwright
          export E2E_BASE_URL
          export E2E_API_URL
          export E2E_TEST_USER_EMAIL
          export E2E_TEST_USER_PASSWORD

          # Run tests with optional pattern
          if [ -n "${{ inputs.test-pattern }}" ]; then
            echo "Running specific test pattern: ${{ inputs.test-pattern }}"
            npx playwright test ${{ inputs.test-pattern }}
          else
            echo "Running all E2E tests"
            npm run test:e2e
          fi
        env:
          E2E_BASE_URL: ${{ steps.resolve-urls.outputs.base-url }}
          E2E_API_URL: ${{ steps.resolve-urls.outputs.api-url }}
          E2E_TEST_USER_EMAIL: ${{ secrets.test-user-email }}
          E2E_TEST_USER_PASSWORD: ${{ secrets.test-user-password }}

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ inputs.environment }}-${{ github.sha }}
          path: frontend/playwright-report/
          retention-days: 30

      - name: Upload test results summary
        if: always()
        run: |
          echo "### E2E Test Results (${{ inputs.environment }}) ðŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend URL**: ${{ steps.resolve-urls.outputs.base-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: ${{ steps.resolve-urls.outputs.api-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Pattern**: ${{ inputs.test-pattern || 'all tests' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f frontend/playwright-report/index.html ]; then
            echo "ðŸ“Š View detailed report in the artifacts section" >> $GITHUB_STEP_SUMMARY
          fi
