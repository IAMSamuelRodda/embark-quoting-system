name: Build

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  AWS_REGION: us-east-1  # TODO: Update to your AWS region
  ECR_REPOSITORY: embark-quoting-backend  # TODO: Update to your ECR repository name

jobs:
  build-backend:
    name: Build Backend Docker Image
    runs-on: ubuntu-latest
    # Only run if AWS credentials are configured
    if: ${{ secrets.AWS_ROLE_TO_ASSUME != '' }}

    permissions:
      id-token: write  # Required for AWS OIDC authentication
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}
        # TODO: Set up AWS OIDC identity provider in AWS IAM
        # TODO: Create IAM role with ECR push permissions
        # TODO: Add AWS_ROLE_TO_ASSUME secret to GitHub

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        # TODO: Create backend/Dockerfile

      - name: Run smoke test on Docker image
        run: |
          docker run -d --name backend-test -p 3000:3000 \
            -e NODE_ENV=test \
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}

          # Wait for health check
          timeout 30 bash -c 'until curl -f http://localhost:3000/health; do sleep 1; done'

          # Verify health check response
          response=$(curl -s http://localhost:3000/health)
          echo "Health check response: $response"

          if echo "$response" | grep -q "ok"; then
            echo "‚úÖ Backend smoke test passed"
          else
            echo "‚ùå Backend smoke test failed"
            docker logs backend-test
            exit 1
          fi

          docker stop backend-test

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          NODE_ENV: production
          # TODO: Add environment-specific variables via GitHub Secrets
          # VITE_API_URL: ${{ secrets.STAGING_API_URL }}
          # VITE_COGNITO_USER_POOL_ID: ${{ secrets.STAGING_COGNITO_USER_POOL_ID }}
          # VITE_COGNITO_CLIENT_ID: ${{ secrets.STAGING_COGNITO_CLIENT_ID }}

      - name: Check build output size
        working-directory: ./frontend
        run: |
          BUILD_SIZE=$(du -sh dist | cut -f1)
          echo "üì¶ Build size: $BUILD_SIZE"

          # Check if dist directory exists
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed: dist directory not found"
            exit 1
          fi

          # Check if index.html exists
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå Build failed: index.html not found"
            exit 1
          fi

          echo "‚úÖ Frontend build successful"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: frontend/dist/
          retention-days: 7

  bundle-analysis:
    name: Analyze Bundle Size
    runs-on: ubuntu-latest
    needs: [build-frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build-${{ github.sha }}
          path: frontend/dist/

      - name: Analyze bundle size
        working-directory: ./frontend
        run: |
          echo "üìä Bundle Analysis:"
          echo "==================="

          # Find and report JavaScript bundle sizes
          find dist/assets -name "*.js" -exec sh -c '
            file="$1"
            size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            size_kb=$((size / 1024))
            filename=$(basename "$file")
            echo "$filename: ${size_kb}KB"

            # Warn if any single bundle exceeds 500KB
            if [ $size_kb -gt 500 ]; then
              echo "‚ö†Ô∏è  WARNING: $filename exceeds 500KB (target: <500KB)"
            fi
          ' sh {} \;

          # Calculate total size
          total_size=$(find dist -type f -exec stat -f%z {} 2>/dev/null \; -o -exec stat -c%s {} 2>/dev/null \; | awk '{sum+=$1} END {print sum/1024}')
          echo ""
          echo "üì¶ Total build size: ${total_size}KB"

          # Enforce 2MB total limit (gzipped should be ~500KB)
          if [ $(echo "$total_size > 2048" | bc) -eq 1 ]; then
            echo "‚ùå Build size exceeds 2MB limit"
            exit 1
          else
            echo "‚úÖ Build size within acceptable limits"
          fi
        # TODO: Add more sophisticated bundle analysis tool like webpack-bundle-analyzer
