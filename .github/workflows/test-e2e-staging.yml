name: E2E Tests (Staging Only)

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      backend_url:
        description: 'Backend URL (e.g., http://3.106.142.134:3000)'
        required: false
        default: ''

jobs:
  e2e-tests:
    name: Run E2E Tests on Staging
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ap-southeast-2

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./frontend
        env:
          # Disable man-db triggers - saves 80+ seconds
          DEBIAN_FRONTEND: noninteractive
        run: |
          # Skip man page updates during package installation (saves ~80 seconds)
          sudo mkdir -p /etc/dpkg/dpkg.cfg.d
          echo 'path-exclude=/usr/share/man/*' | sudo tee /etc/dpkg/dpkg.cfg.d/01_nodoc

          npx playwright install --with-deps chromium

      - name: Get current backend IP (if not provided)
        id: get-backend-ip
        run: |
          if [ -n "${{ github.event.inputs.backend_url }}" ]; then
            echo "backend-url=${{ github.event.inputs.backend_url }}" >> $GITHUB_OUTPUT
            echo "Using provided backend URL: ${{ github.event.inputs.backend_url }}"
          else
            echo "Fetching current backend IP from ECS..."

            # Get the running task ARN
            TASK_ARN=$(aws ecs list-tasks \
              --cluster embark-quoting-staging-cluster \
              --service-name embark-quoting-staging-backend-service \
              --region ap-southeast-2 \
              --query 'taskArns[0]' \
              --output text)

            if [ -z "$TASK_ARN" ] || [ "$TASK_ARN" = "None" ]; then
              echo "‚ùå No running tasks found!"
              exit 1
            fi

            echo "Found task: $TASK_ARN"

            # Get the network interface ID from the task
            ENI_ID=$(aws ecs describe-tasks \
              --cluster embark-quoting-staging-cluster \
              --tasks $TASK_ARN \
              --region ap-southeast-2 \
              --query 'tasks[0].attachments[0].details[?name==`networkInterfaceId`].value' \
              --output text)

            echo "Network interface: $ENI_ID"

            # Get the public IP address
            PUBLIC_IP=$(aws ec2 describe-network-interfaces \
              --network-interface-ids $ENI_ID \
              --region ap-southeast-2 \
              --query 'NetworkInterfaces[0].Association.PublicIp' \
              --output text)

            if [ -z "$PUBLIC_IP" ] || [ "$PUBLIC_IP" = "None" ]; then
              echo "‚ùå Could not get public IP address!"
              exit 1
            fi

            echo "Task public IP: $PUBLIC_IP"
            echo "backend-url=http://${PUBLIC_IP}:3000" >> $GITHUB_OUTPUT
          fi

      - name: Run E2E tests against staging
        working-directory: ./frontend
        timeout-minutes: 2
        run: |
          echo "üîç E2E Test Configuration:"
          echo "  Frontend URL: $E2E_BASE_URL"
          echo "  API URL: $E2E_API_URL"
          echo "  Test User: $E2E_TEST_USER_EMAIL"
          echo ""

          echo "üåê Testing frontend connectivity..."
          if curl -f -s -o /dev/null -w "HTTP %{http_code} in %{time_total}s\n" "$E2E_BASE_URL"; then
            echo "‚úÖ Frontend is reachable"
          else
            echo "‚ùå Frontend is not reachable at $E2E_BASE_URL"
            echo "Attempting to diagnose..."
            curl -v "$E2E_BASE_URL" 2>&1 | head -20
            exit 1
          fi
          echo ""

          echo "üåê Testing API connectivity..."
          if curl -f -s -o /dev/null -w "HTTP %{http_code} in %{time_total}s\n" "$E2E_API_URL/health"; then
            echo "‚úÖ API is reachable"
          else
            echo "‚ùå API is not reachable at $E2E_API_URL"
            exit 1
          fi
          echo ""

          echo "üß™ Running E2E tests..."
          echo "  Using baseURL: $E2E_BASE_URL"
          echo "  Using API URL: $E2E_API_URL"

          npm run test:e2e:validation
        env:
          E2E_BASE_URL: ${{ secrets.STAGING_FRONTEND_URL }}
          E2E_API_URL: ${{ steps.get-backend-ip.outputs.backend-url }}
          E2E_TEST_USER_EMAIL: ${{ secrets.E2E_TEST_USER_EMAIL }}
          E2E_TEST_USER_PASSWORD: ${{ secrets.E2E_TEST_USER_PASSWORD }}

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-e2e-only-${{ github.sha }}
          path: frontend/playwright-report/
          retention-days: 30
