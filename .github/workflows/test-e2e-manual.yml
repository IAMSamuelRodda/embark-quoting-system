name: Manual E2E Tests

# Standalone E2E testing workflow - no deployment required
# Run tests against existing deployed environments
#
# IMPORTANT: Staging API URL Limitation
# ======================================
# Staging uses dynamic ECS public IPs (no ALB/NAT for cost optimization).
# The IP changes whenever the ECS task is replaced (deployment, restart, scaling).
#
# If this workflow fails with "API is not reachable":
# 1. Get current IP: aws ecs describe-tasks + aws ec2 describe-network-interfaces
# 2. Update secret: gh secret set STAGING_API_URL --body "http://<new-ip>:3000"
#
# Note: deploy-staging.yml auto-updates the secret, so deployment-triggered
# E2E tests always work. Only manual tests may need IP refresh.
#
# Production uses ALB with stable DNS endpoint - no IP management needed.

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test against'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'
      test-pattern:
        description: 'Test pattern (blank = all tests, e2e/auth.spec.ts = auth only)'
        required: false
        type: string
        default: ''

jobs:
  e2e-tests:
    name: Run E2E Tests (${{ inputs.environment }})
    uses: ./.github/workflows/e2e-tests.yml
    with:
      environment: ${{ inputs.environment }}
      test-pattern: ${{ inputs.test-pattern }}
    secrets:
      base-url-secret: ${{ inputs.environment == 'staging' && secrets.STAGING_FRONTEND_URL || secrets.PROD_FRONTEND_URL }}
      api-url-secret: ${{ inputs.environment == 'staging' && secrets.STAGING_API_URL || secrets.PROD_API_URL }}
      test-user-email: ${{ inputs.environment == 'staging' && secrets.E2E_TEST_USER_EMAIL || secrets.E2E_PROD_USER_EMAIL }}
      test-user-password: ${{ inputs.environment == 'staging' && secrets.E2E_TEST_USER_PASSWORD || secrets.E2E_PROD_USER_PASSWORD }}
