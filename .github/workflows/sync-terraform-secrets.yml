name: Sync Terraform Outputs to GitHub Secrets

on:
  # Run manually when needed (after terraform apply)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to sync (staging or production)'
        required: true
        type: choice
        options:
          - staging
          - production

  # Can also be triggered by other workflows
  workflow_call:
    inputs:
      environment:
        description: 'Environment to sync'
        required: true
        type: string

env:
  AWS_REGION: ap-southeast-2
  TF_VERSION: '1.9'

jobs:
  sync-secrets:
    name: Sync ${{ inputs.environment }} secrets
    runs-on: ubuntu-latest

    permissions:
      id-token: write  # Required for AWS OIDC
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false  # Disable wrapper to get raw output

      - name: Terraform Init
        working-directory: ./infrastructure/terraform
        run: terraform init

      - name: Select Terraform Workspace
        working-directory: ./infrastructure/terraform
        run: |
          # Use default workspace (all infrastructure in one workspace for now)
          terraform workspace select default

      - name: Get Terraform Outputs
        id: terraform
        working-directory: ./infrastructure/terraform
        run: |
          # Get all outputs as JSON
          terraform output -json > /tmp/terraform-outputs.json

          # Extract individual values (handle sensitive outputs)
          echo "ecr_repository=$(terraform output -raw ecr_repository_name)" >> $GITHUB_OUTPUT
          echo "ecs_cluster=$(terraform output -raw ecs_cluster_name)" >> $GITHUB_OUTPUT
          echo "ecs_service=$(terraform output -raw ecs_service_name)" >> $GITHUB_OUTPUT
          echo "s3_bucket=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT
          echo "cloudfront_id=$(terraform output -raw cloudfront_distribution_id)" >> $GITHUB_OUTPUT
          echo "cloudfront_url=$(terraform output -raw cloudfront_url)" >> $GITHUB_OUTPUT
          echo "cognito_pool_id=$(terraform output -raw cognito_user_pool_id)" >> $GITHUB_OUTPUT
          echo "cognito_client_id=$(terraform output -raw cognito_client_id)" >> $GITHUB_OUTPUT
          echo "e2e_email=$(terraform output -raw e2e_test_user_email)" >> $GITHUB_OUTPUT
          echo "e2e_password=$(terraform output -raw e2e_test_user_password)" >> $GITHUB_OUTPUT
          echo "alb_url=$(terraform output -raw alb_url)" >> $GITHUB_OUTPUT

      - name: Update GitHub Secrets
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          ENV_UPPER=$(echo "${{ inputs.environment }}" | tr '[:lower:]' '[:upper:]')

          echo "ðŸ“ Syncing secrets for ${ENV_UPPER} environment..."

          # Backend (ECS) secrets
          gh secret set "${ENV_UPPER}_ECS_CLUSTER" \
            --body "${{ steps.terraform.outputs.ecs_cluster }}" \
            --repo ${{ github.repository }}

          gh secret set "${ENV_UPPER}_ECS_SERVICE" \
            --body "${{ steps.terraform.outputs.ecs_service }}" \
            --repo ${{ github.repository }}

          gh secret set "${ENV_UPPER}_ECR_REPOSITORY" \
            --body "${{ steps.terraform.outputs.ecr_repository }}" \
            --repo ${{ github.repository }}

          # API URL (from ALB or fallback message)
          if [ "${{ steps.terraform.outputs.alb_url }}" != "ALB_DISABLED" ]; then
            gh secret set "${ENV_UPPER}_API_URL" \
              --body "${{ steps.terraform.outputs.alb_url }}" \
              --repo ${{ github.repository }}
          else
            echo "âš ï¸  ALB disabled - ${ENV_UPPER}_API_URL should be set manually after deployment"
          fi

          # Frontend (S3 + CloudFront) secrets
          gh secret set "${ENV_UPPER}_S3_BUCKET" \
            --body "${{ steps.terraform.outputs.s3_bucket }}" \
            --repo ${{ github.repository }}

          gh secret set "${ENV_UPPER}_CLOUDFRONT_ID" \
            --body "${{ steps.terraform.outputs.cloudfront_id }}" \
            --repo ${{ github.repository }}

          gh secret set "${ENV_UPPER}_FRONTEND_URL" \
            --body "${{ steps.terraform.outputs.cloudfront_url }}" \
            --repo ${{ github.repository }}

          # Cognito secrets
          gh secret set "${ENV_UPPER}_COGNITO_USER_POOL_ID" \
            --body "${{ steps.terraform.outputs.cognito_pool_id }}" \
            --repo ${{ github.repository }}

          gh secret set "${ENV_UPPER}_COGNITO_CLIENT_ID" \
            --body "${{ steps.terraform.outputs.cognito_client_id }}" \
            --repo ${{ github.repository }}

          echo "âœ… ${ENV_UPPER} secrets synced successfully!"

      - name: Update E2E Test Credentials (for staging only)
        if: inputs.environment == 'staging'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "ðŸ“ Syncing E2E test credentials..."

          gh secret set E2E_TEST_USER_EMAIL \
            --body "${{ steps.terraform.outputs.e2e_email }}" \
            --repo ${{ github.repository }}

          gh secret set E2E_TEST_USER_PASSWORD \
            --body "${{ steps.terraform.outputs.e2e_password }}" \
            --repo ${{ github.repository }}

          echo "âœ… E2E test credentials synced!"

      - name: Summary
        run: |
          echo "## ðŸ”„ Secrets Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Environment: **${{ inputs.environment }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Updated Secrets:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ENV_UPPER=$(echo "${{ inputs.environment }}" | tr '[:lower:]' '[:upper:]')

          echo "- \`${ENV_UPPER}_ECS_CLUSTER\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${ENV_UPPER}_ECS_SERVICE\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${ENV_UPPER}_ECR_REPOSITORY\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${ENV_UPPER}_API_URL\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${ENV_UPPER}_S3_BUCKET\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${ENV_UPPER}_CLOUDFRONT_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${ENV_UPPER}_FRONTEND_URL\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${ENV_UPPER}_COGNITO_USER_POOL_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${ENV_UPPER}_COGNITO_CLIENT_ID\`" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.environment }}" = "staging" ]; then
            echo "- \`E2E_TEST_USER_EMAIL\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`E2E_TEST_USER_PASSWORD\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source**: Terraform outputs from \`${{ inputs.environment }}\` workspace" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All GitHub Secrets are now synchronized with your Terraform state! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
